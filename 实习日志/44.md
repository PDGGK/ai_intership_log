# åŸºäº Pydantic çš„è§„åˆ™æ¨¡å‹è®¾è®¡: ç±»å‹å®‰å…¨ä¸æ•°æ®éªŒè¯

<div align="center">
  <img src="https://img.shields.io/badge/Python-3776AB?style=for-the-badge&logo=python&logoColor=white"/>
  <img src="https://img.shields.io/badge/Pydantic-E92063?style=for-the-badge&logo=pydantic&logoColor=white"/>
  <img src="https://img.shields.io/badge/FastAPI-009688?style=for-the-badge&logo=fastapi&logoColor=white"/>
  <img src="https://img.shields.io/badge/JSON-000000?style=for-the-badge&logo=json&logoColor=white"/>
</div>

## å¼•è¨€ <img src="https://img.shields.io/badge/Introduction-FF6B6B?style=flat-square&logo=bookstack&logoColor=white"/>

åœ¨è§„åˆ™è§£æç³»ç»Ÿä¸­,ç¡®ä¿æ•°æ®çš„ç±»å‹å®‰å…¨å’Œæœ‰æ•ˆæ€§æ˜¯è‡³å…³é‡è¦çš„ã€‚æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ Pydantic æ¥æ„å»ºè§„åˆ™æ¨¡å‹,ä¸ä»…å®ç°äº†å¼ºå¤§çš„æ•°æ®éªŒè¯åŠŸèƒ½,è¿˜æä¾›äº†ä¼˜ç§€çš„å¼€å‘ä½“éªŒã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨ Pydantic è®¾è®¡å’Œå®ç°è§„åˆ™æ¨¡å‹ã€‚

## Pydantic çš„ä¼˜åŠ¿ <img src="https://img.shields.io/badge/Advantages-4CAF50?style=flat-square&logo=checkmark&logoColor=white"/>

1. **ç±»å‹å®‰å…¨** ğŸ›¡ï¸
   - è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥
   - è‡ªåŠ¨ç±»å‹è½¬æ¢
   - ç±»å‹æç¤ºæ”¯æŒ

2. **æ•°æ®éªŒè¯** âœ…
   - å¤æ‚çš„éªŒè¯è§„åˆ™
   - è‡ªå®šä¹‰éªŒè¯å™¨
   - è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

3. **å¼€å‘ä½“éªŒ** ğŸ’»
   - IDE æ”¯æŒ
   - è‡ªåŠ¨æ–‡æ¡£ç”Ÿæˆ
   - JSON Schema æ”¯æŒ

## æ¨¡å‹è®¾è®¡ <img src="https://img.shields.io/badge/Model_Design-2196F3?style=flat-square&logo=design&logoColor=white"/>

### 1. åŸºç¡€ç±»å‹å®šä¹‰ ğŸ“

```python
from typing import List, Dict, Any, Optional, Literal
from pydantic import BaseModel, Field

# å·¥å…·ç±»å‹å®šä¹‰
ToolType = Literal[
    "check_logo_presence",
    "image_text_recognition", 
    "image_content_recognition"
]

# åœºæ™¯æ ‡ç­¾å®šä¹‰
SceneTag = Literal["YPGG", "QXGG", "BJGG"]
```

### 2. éªŒè¯é…ç½®æ¨¡å‹ âš™ï¸

```python
class ValidationConfig(BaseModel):
    """éªŒè¯é…ç½®æ¨¡å‹"""
    tool: ToolType = Field(..., description="éªŒè¯å·¥å…·åç§°")
    check: str = Field(..., min_length=1, description="éªŒè¯æ£€æŸ¥å†…å®¹")

    class Config:
        json_schema_extra = {
            "example": {
                "tool": "check_logo_presence",
                "check": "æ£€æŸ¥æ˜¯å¦åŒ…å«æ ‡å‡†çš„ä¿å¥é£Ÿå“æ ‡å¿—"
            }
        }
```

### 3. è§„åˆ™æ¨¡å‹ ğŸ“‹

```python
class ParsedRule(BaseModel):
    """è§£æåçš„è§„åˆ™æ¨¡å‹"""
    rule_id: str = Field(
        ..., 
        pattern=r"^R[a-f0-9]{6}_\d{2}$", 
        description="è§„åˆ™ID"
    )
    source: str = Field(..., min_length=1, description="è§„åˆ™æ¥æºæ¡æ¬¾")
    description: str = Field(..., min_length=1, description="è§„åˆ™æè¿°")
    scene_tags: List[SceneTag] = Field(
        ..., 
        min_items=1, 
        description="åœºæ™¯æ ‡ç­¾"
    )
    validation: ValidationConfig = Field(..., description="éªŒè¯å·¥å…·å’Œæ–¹æ³•")

    class Config:
        json_schema_extra = {
            "example": {
                "rule_id": "R123456_01",
                "source": "ç¬¬Xæ¡",
                "description": "å¹¿å‘Šä¸­å¿…é¡»åŒ…å«ä¿å¥é£Ÿå“æ ‡å¿—",
                "scene_tags": ["BJGG"],
                "validation": {
                    "tool": "check_logo_presence",
                    "check": "æ£€æŸ¥æ˜¯å¦åŒ…å«æ ‡å‡†çš„ä¿å¥é£Ÿå“æ ‡å¿—"
                }
            }
        }
```

### 4. è§„åˆ™é›†åˆæ¨¡å‹ ğŸ“š

```python
class ParsedRuleSet(BaseModel):
    """è§„åˆ™é›†åˆæ¨¡å‹"""
    rules: List[ParsedRule] = Field(..., description="è§£æåçš„è§„åˆ™åˆ—è¡¨")
    metadata: Dict[str, Any] = Field(
        default_factory=dict, 
        description="è§„åˆ™é›†å…ƒæ•°æ®"
    )

    class Config:
        json_schema_extra = {
            "example": {
                "rules": [
                    {
                        "rule_id": "R123456_01",
                        "source": "ç¬¬Xæ¡",
                        "description": "ç¤ºä¾‹è§„åˆ™æè¿°",
                        "scene_tags": ["YPGG"],
                        "validation": {
                            "tool": "text_recognition",
                            "check": "æ£€æŸ¥å¹¿å‘Šå†…å®¹"
                        }
                    }
                ],
                "metadata": {
                    "parsed_at": "2024-01-09T12:00:00",
                    "source_file": "example.txt",
                    "rule_count": 1
                }
            }
        }
```

## éªŒè¯å™¨å®ç° <img src="https://img.shields.io/badge/Validators-FFA000?style=flat-square&logo=validation&logoColor=white"/>

### 1. è‡ªå®šä¹‰éªŒè¯å™¨ ğŸ”§

```python
from pydantic import validator

class ParsedRule(BaseModel):
    # ... å…¶ä»–å­—æ®µå®šä¹‰ ...

    @validator('rule_id')
    def validate_rule_id(cls, v):
        """éªŒè¯è§„åˆ™IDæ ¼å¼"""
        if not re.match(r'^R[a-f0-9]{6}_\d{2}$', v):
            raise ValueError('æ— æ•ˆçš„è§„åˆ™IDæ ¼å¼')
        return v

    @validator('scene_tags')
    def validate_scene_tags(cls, v):
        """éªŒè¯åœºæ™¯æ ‡ç­¾"""
        if not v:
            raise ValueError('åœºæ™¯æ ‡ç­¾ä¸èƒ½ä¸ºç©º')
        return v

    @validator('validation')
    def validate_validation_config(cls, v):
        """éªŒè¯å·¥å…·é…ç½®"""
        if v.tool not in AVAILABLE_TOOLS:
            raise ValueError(f'ä¸æ”¯æŒçš„å·¥å…·: {v.tool}')
        return v
```

### 2. ä¾èµ–éªŒè¯ ğŸ”—

```python
class ValidationConfig(BaseModel):
    tool: ToolType
    check: str

    @validator('tool')
    def validate_tool(cls, v):
        """éªŒè¯å·¥å…·æ˜¯å¦å¯ç”¨"""
        if v not in AVAILABLE_TOOLS:
            raise ValueError(f'ä¸æ”¯æŒçš„å·¥å…·: {v}')
        return v

    @validator('check')
    def validate_check(cls, v):
        """éªŒè¯æ£€æŸ¥å†…å®¹"""
        if len(v.strip()) < 5:
            raise ValueError('æ£€æŸ¥å†…å®¹è¿‡çŸ­')
        return v.strip()
```

## ä½¿ç”¨ç¤ºä¾‹ <img src="https://img.shields.io/badge/Examples-009688?style=flat-square&logo=code&logoColor=white"/>

### 1. æ•°æ®éªŒè¯ âœ…

```python
try:
    # éªŒè¯å•ä¸ªè§„åˆ™
    rule = ParsedRule(
        rule_id="R123456_01",
        source="ç¬¬ä¸€æ¡",
        description="ç¤ºä¾‹è§„åˆ™",
        scene_tags=["YPGG"],
        validation={
            "tool": "image_text_recognition",
            "check": "æ£€æŸ¥å¹¿å‘Šå†…å®¹"
        }
    )
    print("è§„åˆ™éªŒè¯é€šè¿‡")
    
except ValidationError as e:
    print("è§„åˆ™éªŒè¯å¤±è´¥:")
    print(e.json())
```

### 2. JSON Schema ç”Ÿæˆ ğŸ“„

```python
# ç”Ÿæˆ JSON Schema
schema = ParsedRule.schema()
print(json.dumps(schema, indent=2, ensure_ascii=False))
```

### 3. æ•°æ®è½¬æ¢ ğŸ”„

```python
# ä»å­—å…¸åˆ›å»ºæ¨¡å‹
rule_dict = {
    "rule_id": "R123456_01",
    "source": "ç¬¬ä¸€æ¡",
    "description": "ç¤ºä¾‹è§„åˆ™",
    "scene_tags": ["YPGG"],
    "validation": {
        "tool": "image_text_recognition",
        "check": "æ£€æŸ¥å¹¿å‘Šå†…å®¹"
    }
}

rule = ParsedRule(**rule_dict)

# è½¬æ¢ä¸ºå­—å…¸
rule_dict = rule.dict()

# è½¬æ¢ä¸º JSON
rule_json = rule.json(indent=2, ensure_ascii=False)
```

## æœ€ä½³å®è·µ <img src="https://img.shields.io/badge/Best_Practices-607D8B?style=flat-square&logo=practices&logoColor=white"/>

### 1. æ¨¡å‹è®¾è®¡ ğŸ“

1. **å­—æ®µå®šä¹‰** ğŸ“
   - ä½¿ç”¨æ˜ç¡®çš„ç±»å‹æ³¨è§£
   - æ·»åŠ è¯¦ç»†çš„å­—æ®µæè¿°
   - è®¾ç½®é€‚å½“çš„éªŒè¯è§„åˆ™

2. **éªŒè¯è§„åˆ™** âœ…
   - å®ç°å¿…è¦çš„è‡ªå®šä¹‰éªŒè¯å™¨
   - å¤„ç†è¾¹ç•Œæƒ…å†µ

## ç»éªŒæ€»ç»“

1. **ç±»å‹å®‰å…¨**
   - ä½¿ç”¨ä¸¥æ ¼çš„ç±»å‹æ³¨è§£
   - å®ç°å¿…è¦çš„éªŒè¯å™¨
   - å¤„ç†ç±»å‹è½¬æ¢

2. **é”™è¯¯å¤„ç†**
   - æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
   - å®ç°ä¼˜é›…çš„é”™è¯¯å¤„ç†
   - è®°å½•éªŒè¯å¤±è´¥ä¿¡æ¯

3. **å¼€å‘æ•ˆç‡**
   - åˆ©ç”¨ IDE æ”¯æŒ
   - ä½¿ç”¨è‡ªåŠ¨æ–‡æ¡£ç”Ÿæˆ
   - ç»´æŠ¤ç¤ºä¾‹æ•°æ®

## æœªæ¥å±•æœ›

1. **æ¨¡å‹å¢å¼º**
   - æ·»åŠ æ›´å¤šéªŒè¯è§„åˆ™
   - æ”¯æŒå¤æ‚çš„ä¾èµ–å…³ç³»
   - ä¼˜åŒ–æ€§èƒ½è¡¨ç°

2. **å·¥å…·æ”¯æŒ**
   - æ”¹è¿›æ–‡æ¡£ç”Ÿæˆ
   - æ·»åŠ æµ‹è¯•å·¥å…·
   - æä¾›è¿ç§»æ”¯æŒ

3. **é›†æˆæ”¹è¿›**
   - ç®€åŒ–ä½¿ç”¨æ–¹å¼
   - æä¾›æ›´å¤šç¤ºä¾‹
   - å®Œå–„é”™è¯¯å¤„ç†

## æ€»ç»“

åŸºäº Pydantic çš„è§„åˆ™æ¨¡å‹è®¾è®¡ä¸ä»…æä¾›äº†å¼ºå¤§çš„ç±»å‹å®‰å…¨å’Œæ•°æ®éªŒè¯åŠŸèƒ½,è¿˜å¤§å¤§æé«˜äº†å¼€å‘æ•ˆç‡å’Œä»£ç è´¨é‡ã€‚é€šè¿‡åˆç†çš„æ¨¡å‹è®¾è®¡å’ŒéªŒè¯è§„åˆ™,æˆ‘ä»¬æˆåŠŸæ„å»ºäº†ä¸€ä¸ªå¯é ä¸”æ˜“äºç»´æŠ¤çš„è§„åˆ™è§£æç³»ç»Ÿã€‚è¿™äº›ç»éªŒå¯¹äºå…¶ä»–éœ€è¦å¤„ç†å¤æ‚æ•°æ®ç»“æ„çš„é¡¹ç›®ä¹Ÿå…·æœ‰é‡è¦çš„å‚è€ƒä»·å€¼ã€‚ 