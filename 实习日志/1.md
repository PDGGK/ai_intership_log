# å›¾åƒå¯¹æ¯”ç³»ç»Ÿï¼šä»å…¥é—¨åˆ°ç²¾é€š - ä»£ç ä¼˜åŒ–æ•™ç¨‹

<div align="center">
  <img src="https://img.shields.io/badge/Python-3776AB?style=for-the-badge&logo=python&logoColor=white"/>
  <img src="https://img.shields.io/badge/FastAPI-009688?style=for-the-badge&logo=fastapi&logoColor=white"/>
  <img src="https://img.shields.io/badge/Pydantic-E92063?style=for-the-badge&logo=pydantic&logoColor=white"/>
  <img src="https://img.shields.io/badge/Pillow-11557C?style=for-the-badge&logo=python&logoColor=white"/>
</div>

## å¼•è¨€ <img src="https://img.shields.io/badge/Tutorial-FF6B6B?style=flat-square&logo=bookstack&logoColor=white"/>

åœ¨è½¯ä»¶å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å¯¹ä»£ç è¿›è¡Œä¼˜åŒ–å’Œæ”¹è¿›ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ªå®é™…çš„å›¾åƒå¯¹æ¯”ç³»ç»Ÿæ¡ˆä¾‹ï¼Œæ·±å…¥å­¦ä¹ å¦‚ä½•ä¼˜åŒ–Pythonä»£ç ï¼Œæé«˜ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

## ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºç¡€æ¦‚å¿µç†è§£ <img src="https://img.shields.io/badge/Concepts-2196F3?style=flat-square&logo=book&logoColor=white"/>

åœ¨å¼€å§‹ä»£ç å¯¹æ¯”ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆç†è§£å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š

1. **å†…å­˜ç®¡ç†** ğŸ’¾ï¼šç¨‹åºè¿è¡Œæ—¶å¯¹è®¡ç®—æœºå†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾çš„æ§åˆ¶
2. **å¼‚æ­¥ç¼–ç¨‹** âš¡ï¼šå…è®¸ç¨‹åºåœ¨ç­‰å¾…æŸä¸ªæ“ä½œå®Œæˆæ—¶ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡
3. **é”™è¯¯å¤„ç†** ğŸ›¡ï¸ï¼šæ£€æµ‹ã€é¢„é˜²å’Œè§£å†³ç¨‹åºè¿è¡Œæ—¶å¯èƒ½å‡ºç°çš„é—®é¢˜

## ç¬¬äºŒéƒ¨åˆ†ï¼šä»£ç å¯¹æ¯”ä¸åˆ†æ <img src="https://img.shields.io/badge/CodeAnalysis-4CAF50?style=flat-square&logo=code&logoColor=white"/>

### 1. å›¾åƒå¤„ç†æ¨¡å— <img src="https://img.shields.io/badge/ImageProcessing-FF9800?style=flat-square&logo=image&logoColor=white"/>

#### åŸå§‹ç‰ˆæœ¬ï¼š
```python
# ç®€å•çš„å›¾åƒå¤„ç†å®ç°
# è¿™ä¸ªç‰ˆæœ¬ç›´æ¥å°†æ‰€æœ‰å›¾åƒåŠ è½½åˆ°å†…å­˜ä¸­
images = []
for file in files:
    # è¯»å–æ–‡ä»¶å†…å®¹åˆ°å†…å­˜
    content = await file.read()
    # ç›´æ¥æ‰“å¼€å›¾åƒæ–‡ä»¶
    img = Image.open(BytesIO(content))
    # åˆ›å»ºä¸€ä¸ªæ–°çš„ç¼“å†²åŒºæ¥å­˜å‚¨å¤„ç†åçš„å›¾åƒ
    buffered = BytesIO()
    # å°†å›¾åƒä¿å­˜ä¸ºJPEGæ ¼å¼
    img.save(buffered, format="JPEG")
    # è½¬æ¢ä¸ºbase64å­—ç¬¦ä¸²å¹¶å­˜å‚¨
    img_str = "data:image;base64," + base64.b64encode(buffered.getvalue()).decode("utf-8")
    images.append(img_str)
```

#### ä¼˜åŒ–ç‰ˆæœ¬ï¼š
```python
class ImageProcessor:
    """
    å›¾åƒå¤„ç†å·¥å…·ç±»
    è´Ÿè´£å¤„ç†å•ä¸ªå›¾åƒçš„åŠ è½½ã€è½¬æ¢å’Œä¼˜åŒ–æ“ä½œ
    """
    @staticmethod
    async def process_image(
        file: UploadFile,           # è¾“å…¥çš„å›¾åƒæ–‡ä»¶
        max_size: Tuple[int, int],  # å›¾åƒæœ€å¤§å°ºå¯¸é™åˆ¶
        quality: int                # JPEGå‹ç¼©è´¨é‡
    ) -> Optional[str]:
        """
        å¤„ç†å•ä¸ªå›¾åƒæ–‡ä»¶
        
        Args:
            file: ä¸Šä¼ çš„å›¾åƒæ–‡ä»¶
            max_size: æœ€å¤§å…è®¸çš„å›¾åƒå°ºå¯¸(å®½,é«˜)
            quality: JPEGå‹ç¼©è´¨é‡(1-100)
            
        Returns:
            Optional[str]: å¤„ç†åçš„base64å›¾åƒå­—ç¬¦ä¸²ï¼Œå¤±è´¥åˆ™è¿”å›None
        """
        try:
            # è¯»å–æ–‡ä»¶å†…å®¹
            content = await file.read()
            
            # ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾
            with Image.open(BytesIO(content)) as img:
                # ç¡®ä¿å›¾åƒæ ¼å¼å…¼å®¹æ€§
                if img.mode != 'RGB':
                    img = img.convert('RGB')
                
                # æŒ‰æ¯”ä¾‹ç¼©æ”¾å›¾åƒï¼Œä¿æŒå®½é«˜æ¯”
                img.thumbnail(max_size, Image.Resampling.LANCZOS)
                
                # ä¼˜åŒ–å›¾åƒä¿å­˜è¿‡ç¨‹
                buffered = BytesIO()
                img.save(
                    buffered,
                    format="JPEG",
                    quality=quality,    # æ§åˆ¶å‹ç¼©è´¨é‡
                    optimize=True       # å¯ç”¨ä¼˜åŒ–
                )
                
                # è½¬æ¢ä¸ºbase64å¹¶è¿”å›
                return "data:image;base64," + base64.b64encode(buffered.getvalue()).decode("utf-8")
                
        except Exception as e:
            # è¯¦ç»†è®°å½•é”™è¯¯ä¿¡æ¯
            logger.error(f"å›¾åƒå¤„ç†å¤±è´¥: {str(e)}")
            return None
```

### 2. é…ç½®ç®¡ç† <img src="https://img.shields.io/badge/Config-607D8B?style=flat-square&logo=settings&logoColor=white"/>

#### åŸå§‹ç‰ˆæœ¬ï¼š
```python
# ç®€å•çš„é…ç½®å®šä¹‰
class ImageComparisonConfig(BaseModel):
    focus_elements: List[str] = Field(
        default=["æ•´ä½“å†…å®¹"],
        description="éœ€è¦é‡ç‚¹å…³æ³¨çš„å…ƒç´ åˆ—è¡¨"
    )
    comparison_aspects: List[str] = Field(
        default=["å†…å®¹", "ä½ç½®", "æ¸…æ™°åº¦"],
        description="éœ€è¦å¯¹æ¯”çš„æ–¹é¢"
    )
    similarity_threshold: float = Field(
        default=0.8,
        description="ç›¸ä¼¼åº¦é˜ˆå€¼"
    )
```

#### ä¼˜åŒ–ç‰ˆæœ¬ï¼š
```python
class ImageComparisonConfig(BaseModel):
    """
    å›¾åƒå¯¹æ¯”é…ç½®ç±»
    æ§åˆ¶æ•´ä¸ªå¯¹æ¯”è¿‡ç¨‹çš„è¡Œä¸ºå’Œé™åˆ¶
    """
    # åŸºç¡€å¯¹æ¯”å‚æ•°
    focus_elements: List[str] = Field(
        default=["æ•´ä½“å†…å®¹"],
        description="éœ€è¦é‡ç‚¹å…³æ³¨çš„å…ƒç´ åˆ—è¡¨ï¼Œå¦‚['æ ‡å¿—', 'æ–‡å­—', 'é¢œè‰²']ç­‰"
    )
    
    comparison_aspects: List[str] = Field(
        default=["å†…å®¹", "ä½ç½®", "æ¸…æ™°åº¦"],
        description="éœ€è¦å¯¹æ¯”çš„æ–¹é¢"
    )
    
    # æ€§èƒ½ç›¸å…³å‚æ•°
    similarity_threshold: float = Field(
        default=0.8,
        description="ç›¸ä¼¼åº¦é˜ˆå€¼ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦è¶³å¤Ÿç›¸ä¼¼"
    )
    
    max_image_size: Tuple[int, int] = Field(
        default=(1024, 1024),
        description="å›¾åƒæœ€å¤§å°ºå¯¸é™åˆ¶ï¼Œç”¨äºæ§åˆ¶å†…å­˜ä½¿ç”¨"
    )
    
    # å›¾åƒè´¨é‡å‚æ•°
    image_quality: int = Field(
        default=85,
        description="JPEGå‹ç¼©è´¨é‡(1-100)",
        ge=1,    # å¤§äºç­‰äº1
        le=100   # å°äºç­‰äº100
    )
    
    # æ€§èƒ½æ§åˆ¶å‚æ•°
    processing_timeout: int = Field(
        default=30,
        description="å¤„ç†è¶…æ—¶æ—¶é—´(ç§’)"
    )

    @validator('similarity_threshold')
    def validate_threshold(cls, v):
        """
        éªŒè¯ç›¸ä¼¼åº¦é˜ˆå€¼æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
        """
        if not 0 <= v <= 1:
            raise ValueError('ç›¸ä¼¼åº¦é˜ˆå€¼å¿…é¡»åœ¨0å’Œ1ä¹‹é—´')
        return v
```

### 3. ä¸»å¤„ç†æµç¨‹ <img src="https://img.shields.io/badge/MainProcess-9C27B0?style=flat-square&logo=process&logoColor=white"/>

#### åŸå§‹ç‰ˆæœ¬ï¼š
```python
async def compare_images_v2(
    files: List[UploadFile],
    config: Optional[ImageComparisonConfig] = None
) -> BaseResponse:
    try:
        # åŸºç¡€éªŒè¯
        if len(files) != 2:
            return BaseResponse(code=400, msg="è¯·æä¾›ä¸¤ä¸ªæ–‡ä»¶", data=None)

        # å¤„ç†æ‰€æœ‰å›¾åƒ
        images = []
        for file in files:
            # å¤„ç†å›¾åƒå¹¶å­˜å‚¨ç»“æœ
            image_data = process_image(file)
            images.append(image_data)

        # è¿›è¡ŒVLåˆ†æ
        results = await vl_chat(images)

        return BaseResponse(code=200, msg="å¤„ç†æˆåŠŸ", data=results)
    except Exception as e:
        return BaseResponse(code=500, msg=str(e), data=None)
```

#### ä¼˜åŒ–ç‰ˆæœ¬ï¼š
```python
async def compare_images_v2(
    files: List[UploadFile],
    config: Optional[ImageComparisonConfig] = None
) -> BaseResponse:
    """
    ä¼˜åŒ–åçš„å›¾åƒå¯¹æ¯”ä¸»å‡½æ•°
    
    å®ç°äº†å®Œæ•´çš„å›¾åƒå¯¹æ¯”æµç¨‹ï¼ŒåŒ…æ‹¬ï¼š
    1. å‚æ•°éªŒè¯
    2. å›¾åƒå¤„ç†
    3. VLæ¨¡å‹åˆ†æ
    4. ç»“æœæ ¼å¼åŒ–
    
    Args:
        files: è¦å¯¹æ¯”çš„å›¾åƒæ–‡ä»¶åˆ—è¡¨
        config: å¯¹æ¯”é…ç½®å‚æ•°
        
    Returns:
        BaseResponse: åŒ…å«å¯¹æ¯”ç»“æœçš„å“åº”å¯¹è±¡
    """
    try:
        # å‚æ•°éªŒè¯å’Œåˆå§‹åŒ–
        if len(files) != 2:
            return BaseResponse(
                code=400,
                msg="è¯·æä¾›ä¸¤ä¸ªæ–‡ä»¶è¿›è¡Œå¯¹æ¯”",
                data=None
            )

        # ä½¿ç”¨é»˜è®¤é…ç½®æˆ–ä¼ å…¥çš„é…ç½®
        config = config or ImageComparisonConfig()
        
        # åˆ›å»ºå¤„ç†å™¨å®ä¾‹
        processor = ImageProcessor()
        vl_manager = VLChatManager()

        # ä¸²è¡Œå¤„ç†æ¯ä¸ªå›¾åƒ
        processed_images = []
        for file in files:
            # ä½¿ç”¨é…ç½®çš„å‚æ•°å¤„ç†å›¾åƒ
            image_data = await processor.process_image(
                file,
                config.max_image_size,
                config.image_quality
            )
            
            # æ£€æŸ¥å¤„ç†ç»“æœ
            if not image_data:
                return BaseResponse(
                    code=400,
                    msg="å›¾åƒå¤„ç†å¤±è´¥",
                    data=None
                )
            processed_images.append(image_data)

        # æ„å»ºåˆ†ææç¤ºè¯
        initial_prompt = """è¯·å¯¹è¿™å¼ å›¾ç‰‡è¿›è¡Œè¯¦ç»†åˆ†æï¼Œæè¿°ï¼š
1. ä¸»è¦å†…å®¹å’Œå¸ƒå±€
2. å…³é”®è§†è§‰å…ƒç´ 
3. å›¾åƒè´¨é‡å’Œæ¸…æ™°åº¦
"""

        # åˆ†åˆ«è·å–æ¯ä¸ªå›¾åƒçš„æè¿°
        image_descriptions = []
        for image in processed_images:
            # ä½¿ç”¨VLæ¨¡å‹åˆ†æå›¾åƒ
            description = await vl_manager.get_image_description(
                image,
                initial_prompt,
                config.processing_timeout
            )
            
            # éªŒè¯åˆ†æç»“æœ
            if not description:
                return BaseResponse(
                    code=500,
                    msg="å›¾åƒåˆ†æå¤±è´¥",
                    data=None
                )
            image_descriptions.append(description)

        # ç”Ÿæˆæœ€ç»ˆçš„æ¯”è¾ƒç»“æœ
        try:
            result = ComparisonResult(
                overall_similarity=calculate_similarity(image_descriptions),
                element_comparison=compare_elements(image_descriptions),
                detailed_differences=find_differences(image_descriptions),
                analysis_confidence=calculate_confidence(image_descriptions)
            )
            
            return BaseResponse(
                code=200,
                msg="å¯¹æ¯”å®Œæˆ",
                data=result
            )

        except Exception as e:
            logger.error(f"ç»“æœå¤„ç†å¤±è´¥: {str(e)}")
            return BaseResponse(
                code=400,
                msg=f"ç»“æœå¤„ç†å¤±è´¥: {str(e)}",
                data=None
            )

    except Exception as e:
        # è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯
        logger.error(f"å›¾åƒå¯¹æ¯”è¿‡ç¨‹å‘ç”Ÿé”™è¯¯: {str(e)}")
        return BaseResponse(
            code=500,
            msg=f"å¤„ç†å¤±è´¥: {str(e)}",
            data=None
        )
```

## ä¼˜åŒ–è¦ç‚¹æ€»ç»“ <img src="https://img.shields.io/badge/Summary-00BCD4?style=flat-square&logo=checkmarx&logoColor=white"/>

1. âœ¨ **ä»£ç ç»“æ„ä¼˜åŒ–**
   - ç±»çš„åˆç†åˆ’åˆ†
   - èŒè´£æ˜ç¡®åˆ†ç¦»
   - æ¨¡å—åŒ–è®¾è®¡

2. ğŸ›¡ï¸ **é”™è¯¯å¤„ç†å¢å¼º**
   - å¼‚å¸¸æ•è·å®Œå–„
   - æ—¥å¿—è®°å½•è¯¦ç»†
   - é”™è¯¯æç¤ºå‹å¥½

3. âš™ï¸ **é…ç½®ç®¡ç†æ”¹è¿›**
   - å‚æ•°éªŒè¯
   - é»˜è®¤å€¼è®¾ç½®
   - æ–‡æ¡£å®Œå–„

4. ğŸš€ **æ€§èƒ½ä¼˜åŒ–**
   - å†…å­˜ä½¿ç”¨ä¼˜åŒ–
   - å¼‚æ­¥å¤„ç†
   - èµ„æºåŠæ—¶é‡Šæ”¾

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ ¸å¿ƒä¼˜åŒ–ç‚¹åˆ†æ

1. **å†…å­˜ç®¡ç†ä¼˜åŒ–**
   - åŸå§‹ç‰ˆæœ¬ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰å›¾åƒ
   - ä¼˜åŒ–ç‰ˆæœ¬é‡‡ç”¨ä¸²è¡Œå¤„ç†ï¼Œæ§åˆ¶å†…å­˜ä½¿ç”¨

2. **é”™è¯¯å¤„ç†å¢å¼º**
   - åŸå§‹ç‰ˆæœ¬åªæœ‰åŸºç¡€é”™è¯¯æ•è·
   - ä¼˜åŒ–ç‰ˆæœ¬å®ç°äº†åˆ†å±‚é”™è¯¯å¤„ç†å’Œè¯¦ç»†æ—¥å¿—

3. **ä»£ç ç»“æ„ä¼˜åŒ–**
   - åŸå§‹ç‰ˆæœ¬åŠŸèƒ½é›†ä¸­åœ¨å•ä¸ªå‡½æ•°
   - ä¼˜åŒ–ç‰ˆæœ¬é‡‡ç”¨ç±»çš„æ–¹å¼ç»„ç»‡ä»£ç 

4. **é…ç½®ç®¡ç†æ”¹è¿›**
   - åŸå§‹ç‰ˆæœ¬é…ç½®é€‰é¡¹æœ‰é™
   - ä¼˜åŒ–ç‰ˆæœ¬æä¾›äº†å®Œæ•´çš„é…ç½®ä½“ç³»

## ç¬¬å››éƒ¨åˆ†ï¼šæœ€ä½³å®è·µå»ºè®®

1. **å†…å­˜ç®¡ç†åŸåˆ™**
- æ€»æ˜¯é™åˆ¶å›¾åƒå°ºå¯¸
- ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨
- åŠæ—¶é‡Šæ”¾èµ„æº

2. **é”™è¯¯å¤„ç†åŸåˆ™**
- å®ç°åˆ†å±‚é”™è¯¯å¤„ç†
- æä¾›è¯¦ç»†é”™è¯¯ä¿¡æ¯
- è®°å½•å®Œæ•´é”™è¯¯æ—¥å¿—

3. **ä»£ç ç»„ç»‡åŸåˆ™**
- åŠŸèƒ½æ¨¡å—åŒ–
- èŒè´£å•ä¸€
- æ¥å£æ¸…æ™°

## ç»“è¯­

é€šè¿‡æœ¬æ•™ç¨‹ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•é€šè¿‡ç³»ç»Ÿæ€§çš„ä¼˜åŒ–æå‡ä»£ç è´¨é‡ã€‚è¿™äº›ä¼˜åŒ–ä¸ä»…æé«˜äº†ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä¹Ÿå¤§å¤§å¢å¼ºäº†ä»£ç çš„å¯ç»´æŠ¤æ€§ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥æ ¹æ®å…·ä½“åœºæ™¯é€‰æ‹©åˆé€‚çš„ä¼˜åŒ–ç­–ç•¥ã€‚

è®°ä½ï¼Œå¥½çš„ä»£ç ä¸ä»…è¦è¿è¡Œæ­£ç¡®ï¼Œè¿˜è¦æ˜“äºç†è§£å’Œç»´æŠ¤ã€‚é€šè¿‡æ·»åŠ é€‚å½“çš„æ³¨é‡Šã€ä½¿ç”¨æ¸…æ™°çš„å‘½åå’Œåˆç†çš„ç»“æ„ç»„ç»‡ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå‡ºæ›´å¥½çš„è½¯ä»¶ç³»ç»Ÿã€‚