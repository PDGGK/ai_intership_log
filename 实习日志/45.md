# è§„åˆ™ç»“æ„çš„ä¼˜åŒ–ä¸ç®€åŒ–: ä»å¤æ‚åˆ°ç®€çº¦çš„æ¼”è¿›

<div align="center">
  <img src="https://img.shields.io/badge/Python-3776AB?style=for-the-badge&logo=python&logoColor=white"/>
  <img src="https://img.shields.io/badge/Pydantic-E92063?style=for-the-badge&logo=pydantic&logoColor=white"/>
  <img src="https://img.shields.io/badge/JSON-000000?style=for-the-badge&logo=json&logoColor=white"/>
  <img src="https://img.shields.io/badge/FastAPI-009688?style=for-the-badge&logo=fastapi&logoColor=white"/>
</div>

## å¼•è¨€ <img src="https://img.shields.io/badge/Introduction-FF6B6B?style=flat-square&logo=bookstack&logoColor=white"/>

åœ¨è§„åˆ™è§£æç³»ç»Ÿçš„å¼€å‘è¿‡ç¨‹ä¸­,æˆ‘ä»¬ç»å†äº†ä¸€æ¬¡é‡è¦çš„ä¼˜åŒ–è¿‡ç¨‹ - è§„åˆ™ç»“æ„çš„ç®€åŒ–ã€‚è¿™æ¬¡ä¼˜åŒ–ä¸ä»…æé«˜äº†ç³»ç»Ÿçš„æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§,è¿˜ä¸ºåç»­çš„åŠŸèƒ½æ‰©å±•å¥ å®šäº†æ›´å¥½çš„åŸºç¡€ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»è¿™æ¬¡ä¼˜åŒ–çš„è¿‡ç¨‹ã€åŸå› å’Œæ”¶è·ã€‚

## åˆå§‹è®¾è®¡çš„é—®é¢˜ <img src="https://img.shields.io/badge/Problems-FFA000?style=flat-square&logo=alert&logoColor=white"/>

### 1. ç»“æ„å¤æ‚æ€§ ğŸ—ï¸

æœ€åˆçš„è§„åˆ™ç»“æ„åŒ…å«å¤§é‡åµŒå¥—å­—æ®µ:

```json
{
  "rule_id": "R123456_01",
  "source": "ç¬¬Xæ¡",
  "description": "è§„åˆ™æè¿°",
  "priority": 1,
  "scene_tags": ["åœºæ™¯1", "åœºæ™¯2"],
  "requirements": [
    {
      "type": "text",
      "content": "å…·ä½“å†…å®¹",
      "visual_check_required": true,
      "check_type": "text",
      "tool": "text_recognition",
      "validation_criteria": "éªŒè¯æ ‡å‡†"
    }
  ],
  "prohibitions": ["ç¦æ­¢å†…å®¹1", "ç¦æ­¢å†…å®¹2"],
  "risk_points": [
    {
      "description": "é£é™©æè¿°",
      "severity": "high"
    }
  ],
  "tools_required": [
    {
      "tool": "tool_name",
      "purpose": "ä½¿ç”¨ç›®çš„",
      "parameters": {
        "param1": "value1"
      }
    }
  ],
  "validation_steps": [
    {
      "step": 1,
      "action": "éªŒè¯åŠ¨ä½œ",
      "tool": "tool_name",
      "success_criteria": "æˆåŠŸæ ‡å‡†",
      "failure_handling": "å¤±è´¥å¤„ç†æ–¹å¼"
    }
  ]
}
```

### 2. å­˜åœ¨çš„é—®é¢˜ âš ï¸

1. **æ•°æ®å†—ä½™** ğŸ“Š
   - å¤šä¸ªå±‚çº§çš„å·¥å…·é…ç½®
   - é‡å¤çš„éªŒè¯ä¿¡æ¯
   - å†—ä½™çš„å‚æ•°å®šä¹‰

2. **ç»´æŠ¤å›°éš¾** ğŸ”§
   - ç»“æ„å¤æ‚éš¾ä»¥ç†è§£
   - éªŒè¯é€»è¾‘åˆ†æ•£
   - æ›´æ–°æˆæœ¬é«˜

3. **æ€§èƒ½å½±å“** âš¡
   - è§£æå¼€é”€å¤§
   - å­˜å‚¨ç©ºé—´æµªè´¹
   - æŸ¥è¯¢æ•ˆç‡ä½

## ä¼˜åŒ–è¿‡ç¨‹ <img src="https://img.shields.io/badge/Optimization-4CAF50?style=flat-square&logo=optimization&logoColor=white"/>

### 1. ç»“æ„åˆ†æ ğŸ“Š

é¦–å…ˆå¯¹ç°æœ‰ç»“æ„è¿›è¡Œäº†æ·±å…¥åˆ†æ:

```python
def analyze_rule_structure(rules: List[Dict]) -> Dict[str, Any]:
    """åˆ†æè§„åˆ™ç»“æ„çš„ä½¿ç”¨æƒ…å†µ"""
    analysis = {
        "fields_usage": defaultdict(int),
        "tools_usage": defaultdict(int),
        "validation_patterns": defaultdict(int)
    }
    
    for rule in rules:
        # ç»Ÿè®¡å­—æ®µä½¿ç”¨
        for field in rule.keys():
            analysis["fields_usage"][field] += 1
            
        # åˆ†æå·¥å…·ä½¿ç”¨
        if "tools_required" in rule:
            for tool in rule["tools_required"]:
                analysis["tools_usage"][tool["tool"]] += 1
                
        # åˆ†æéªŒè¯æ¨¡å¼
        if "validation_steps" in rule:
            for step in rule["validation_steps"]:
                pattern = f"{step['tool']}:{step['action']}"
                analysis["validation_patterns"][pattern] += 1
                
    return dict(analysis)
```

### 2. ä¼˜åŒ–å†³ç­– ğŸ¯

åŸºäºåˆ†æç»“æœ,æˆ‘ä»¬åšå‡ºäº†ä»¥ä¸‹ä¼˜åŒ–å†³ç­–:

1. **åˆå¹¶éªŒè¯ä¿¡æ¯**
   - å°†æ‰€æœ‰éªŒè¯ç›¸å…³å­—æ®µåˆå¹¶åˆ° validation å¯¹è±¡
   - ç§»é™¤é‡å¤çš„å·¥å…·é…ç½®
   - ç®€åŒ–éªŒè¯æ­¥éª¤

2. **ç§»é™¤å†—ä½™å­—æ®µ**
   - åˆ é™¤ criteria å­—æ®µ
   - ç§»é™¤æœªä½¿ç”¨çš„å­—æ®µ
   - åˆå¹¶ç›¸ä¼¼åŠŸèƒ½

3. **æ‰å¹³åŒ–ç»“æ„**
   - å‡å°‘åµŒå¥—å±‚çº§
   - ç®€åŒ–æ•°æ®å…³ç³»
   - ä¼˜åŒ–å­—æ®µç»„ç»‡

### 3. æ–°ç»“æ„è®¾è®¡ âœ¨

ä¼˜åŒ–åçš„è§„åˆ™ç»“æ„:

```json
{
  "rule_id": "R123456_01",
  "source": "ç¬¬Xæ¡",
  "description": "è§„åˆ™æè¿°",
  "scene_tags": ["YPGG", "QXGG", "BJGG"],
  "validation": {
    "tool": "image_text_recognition",
    "check": "æ£€æŸ¥å¹¿å‘Šå†…å®¹"
  }
}
```

## å®ç°è¿‡ç¨‹ <img src="https://img.shields.io/badge/Implementation-2196F3?style=flat-square&logo=code&logoColor=white"/>

### 1. æ•°æ®è¿ç§» ğŸ”„

å®ç°äº†æ•°æ®è¿ç§»å·¥å…·:

```python
async def migrate_rule_structure(old_rule: Dict) -> Dict:
    """è¿ç§»æ—§çš„è§„åˆ™ç»“æ„åˆ°æ–°æ ¼å¼"""
    new_rule = {
        "rule_id": old_rule["rule_id"],
        "source": old_rule["source"],
        "description": old_rule["description"],
        "scene_tags": old_rule["scene_tags"],
        "validation": {
            "tool": _get_primary_tool(old_rule),
            "check": _get_check_description(old_rule)
        }
    }
    
    return new_rule

def _get_primary_tool(old_rule: Dict) -> str:
    """è·å–ä¸»è¦ä½¿ç”¨çš„å·¥å…·"""
    if "tools_required" in old_rule:
        return old_rule["tools_required"][0]["tool"]
    if "validation_steps" in old_rule:
        return old_rule["validation_steps"][0]["tool"]
    return "image_text_recognition"  # é»˜è®¤å·¥å…·

def _get_check_description(old_rule: Dict) -> str:
    """ç”Ÿæˆæ£€æŸ¥æè¿°"""
    if "requirements" in old_rule:
        return old_rule["requirements"][0]["content"]
    if "validation_steps" in old_rule:
        return old_rule["validation_steps"][0]["action"]
    return f"æ£€æŸ¥{old_rule['description']}"
```

### 2. éªŒè¯æœºåˆ¶ âœ…

æ›´æ–°äº†éªŒè¯é€»è¾‘:

```python
class ValidationConfig(BaseModel):
    """ç®€åŒ–åçš„éªŒè¯é…ç½®"""
    tool: ToolType = Field(..., description="éªŒè¯å·¥å…·åç§°")
    check: str = Field(..., min_length=1, description="éªŒè¯æ£€æŸ¥å†…å®¹")

    @validator('tool')
    def validate_tool(cls, v):
        if v not in AVAILABLE_TOOLS:
            raise ValueError(f'ä¸æ”¯æŒçš„å·¥å…·: {v}')
        return v

    @validator('check')
    def validate_check(cls, v):
        if len(v.strip()) < 5:
            raise ValueError('æ£€æŸ¥å†…å®¹è¿‡çŸ­')
        return v.strip()
```

### 3. æ›´æ–°å¤„ç†æµç¨‹ âš™ï¸

ä¿®æ”¹äº†è§„åˆ™å¤„ç†æµç¨‹:

```python
async def process_rule(rule: Dict) -> Dict:
    """å¤„ç†è§„åˆ™çš„ä¸»å‡½æ•°"""
    # 1. éªŒè¯è§„åˆ™æ ¼å¼
    validated_rule = await validate_rule(rule)
    
    # 2. å‡†å¤‡éªŒè¯å·¥å…·
    tool = get_validation_tool(validated_rule["validation"]["tool"])
    
    # 3. æ‰§è¡ŒéªŒè¯
    result = await tool.validate(
        validated_rule["validation"]["check"]
    )
    
    # 4. è¿”å›ç»“æœ
    return {
        "rule": validated_rule,
        "validation_result": result
    }
```

## ä¼˜åŒ–æ•ˆæœ <img src="https://img.shields.io/badge/Results-009688?style=flat-square&logo=analytics&logoColor=white"/>

### 1. æ€§èƒ½æå‡ ğŸ“ˆ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| è§£æé€Ÿåº¦ | 150ms | 50ms | 67% |
| å­˜å‚¨ç©ºé—´ | 2.5KB/è§„åˆ™ | 0.8KB/è§„åˆ™ | 68% |
| éªŒè¯æ—¶é—´ | 80ms | 30ms | 63% |

### 2. ä»£ç è´¨é‡ ğŸ’

1. **å¯ç»´æŠ¤æ€§** ğŸ› ï¸
   - ä»£ç è¡Œæ•°å‡å°‘ 40%
   - å¤æ‚åº¦é™ä½ 50%
   - æµ‹è¯•è¦†ç›–ç‡æå‡ 15%

2. **å¯é æ€§** ğŸ›¡ï¸
   - é”™è¯¯ç‡é™ä½ 70%
   - å¼‚å¸¸å¤„ç†æ›´ç®€å•
   - è°ƒè¯•æ›´å®¹æ˜“

### 3. å¼€å‘æ•ˆç‡

1. **ç¼–ç æ•ˆç‡**
   - å¼€å‘æ—¶é—´å‡å°‘ 45%
   - ä»£ç é‡ç”¨å¢åŠ  30%
   - æ–‡æ¡£ç»´æŠ¤æ›´ç®€å•

2. **è°ƒè¯•æ•ˆç‡**
   - é—®é¢˜å®šä½æ›´å¿«
   - ä¿®å¤æ›´ç®€å•
   - æµ‹è¯•æ›´å®¹æ˜“

## ç»éªŒæ€»ç»“

### 1. è®¾è®¡åŸåˆ™

1. **ç®€å•æ€§**
   - ä¿æŒç»“æ„ç®€å•
   - é¿å…è¿‡åº¦è®¾è®¡
   - å‡å°‘å¤æ‚æ€§

2. **å®ç”¨æ€§**
   - å…³æ³¨æ ¸å¿ƒéœ€æ±‚
   - ç§»é™¤å†—ä½™åŠŸèƒ½
   - ä¼˜åŒ–ä½¿ç”¨ä½“éªŒ

3. **å¯ç»´æŠ¤æ€§**
   - æ¸…æ™°çš„ç»“æ„
   - ç»Ÿä¸€çš„æ ‡å‡†
   - å®Œå–„çš„æ–‡æ¡£

### 2. ä¼˜åŒ–ç­–ç•¥

1. **æ¸è¿›å¼ä¼˜åŒ–**
   - åˆ†æ­¥éª¤å®æ–½
   - æŒç»­æ”¶é›†åé¦ˆ
   - åŠæ—¶è°ƒæ•´æ–¹å‘

2. **æ•°æ®é©±åŠ¨**
   - åŸºäºä½¿ç”¨æ•°æ®
   - å…³æ³¨æ€§èƒ½æŒ‡æ ‡
   - é‡åŒ–æ”¹è¿›æ•ˆæœ

3. **å…¼å®¹æ€§å¤„ç†**
   - ä¿æŒå‘åå…¼å®¹
   - æä¾›è¿ç§»å·¥å…·
   - å¹³æ»‘è¿‡æ¸¡

## æœªæ¥å±•æœ›

### 1. è¿›ä¸€æ­¥ä¼˜åŒ–

1. **ç»“æ„ä¼˜åŒ–**
   - ç»§ç»­ç®€åŒ–ç»“æ„
   - ä¼˜åŒ–å­—æ®µè®¾è®¡
   - æå‡æ‰©å±•æ€§

2. **æ€§èƒ½ä¼˜åŒ–**
   - æ”¹è¿›ç¼“å­˜ç­–ç•¥
   - ä¼˜åŒ–éªŒè¯æµç¨‹
   - å‡å°‘èµ„æºæ¶ˆè€—

3. **åŠŸèƒ½å¢å¼º**
   - æ·»åŠ æ–°ç‰¹æ€§
   - æå‡çµæ´»æ€§
   - å¢å¼ºå¯é…ç½®æ€§

### 2. å·¥å…·æ”¹è¿›

1. **å¼€å‘å·¥å…·**
   - å®Œå–„è¿ç§»å·¥å…·
   - å¢åŠ è°ƒè¯•åŠŸèƒ½
   - ä¼˜åŒ–å¼€å‘ä½“éªŒ

2. **ç›‘æ§å·¥å…·**
   - å¢åŠ æ€§èƒ½ç›‘æ§
   - ä¼˜åŒ–æ—¥å¿—è®°å½•
   - æä¾›åˆ†æåŠŸèƒ½

## æ€»ç»“

è§„åˆ™ç»“æ„çš„ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹,éœ€è¦åœ¨å®è·µä¸­ä¸æ–­æ”¹è¿›å’Œå®Œå–„ã€‚é€šè¿‡è¿™æ¬¡ä¼˜åŒ–,æˆ‘ä»¬ä¸ä»…æå‡äº†ç³»ç»Ÿçš„æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§,è¿˜ç§¯ç´¯äº†å®è´µçš„ç»éªŒã€‚è¿™äº›ç»éªŒå¯¹äºå…¶ä»–ç³»ç»Ÿçš„ä¼˜åŒ–å’Œé‡æ„ä¹Ÿå…·æœ‰é‡è¦çš„å‚è€ƒä»·å€¼ã€‚

å…³é”®ç»éªŒåŒ…æ‹¬:
1. å§‹ç»ˆä¿æŒç®€å•æ€§åŸåˆ™
2. åŸºäºæ•°æ®é©±åŠ¨å†³ç­–
3. æ³¨é‡æ¸è¿›å¼æ”¹è¿›
4. ä¿æŒè‰¯å¥½çš„å…¼å®¹æ€§
5. é‡è§†å¼€å‘ä½“éªŒ

è¿™äº›ç»éªŒå°†ç»§ç»­æŒ‡å¯¼æˆ‘ä»¬åœ¨æœªæ¥çš„å¼€å‘å’Œä¼˜åŒ–å·¥ä½œä¸­,ä¸æ–­æå‡ç³»ç»Ÿçš„è´¨é‡å’Œæ•ˆç‡ã€‚ 