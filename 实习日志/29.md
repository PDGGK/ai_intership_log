# FastAPI ç³»ç»Ÿé”™è¯¯å¤„ç†ä¸å¥å£®æ€§ä¼˜åŒ–

<div align="center">
  <img src="https://img.shields.io/badge/FastAPI-009688?style=for-the-badge&logo=fastapi&logoColor=white"/>
  <img src="https://img.shields.io/badge/Python-3776AB?style=for-the-badge&logo=python&logoColor=white"/>
  <img src="https://img.shields.io/badge/Pydantic-E92063?style=for-the-badge&logo=pydantic&logoColor=white"/>
  <img src="https://img.shields.io/badge/OpenAI-412991?style=for-the-badge&logo=openai&logoColor=white"/>
</div>

## 2024-12-17 æŠ€æœ¯å­¦ä¹ æ—¥å¿—ï¼šFastAPI ç³»ç»Ÿé”™è¯¯å¤„ç†ä¸å¥å£®æ€§ä¼˜åŒ–

## æ ¸å¿ƒé—®é¢˜æ¢³ç† <img src="https://img.shields.io/badge/Analysis-FF6B6B?style=flat-square&logo=target&logoColor=white"/>

### é—®é¢˜ç°è±¡ ğŸ”

1. **ç‰¹å®šåœºæ™¯å¤±è´¥** âŒ
   - ä»…ç‰¹å®š JPG æ–‡ä»¶æµ‹è¯•å¤±è´¥
   - å…¶ä»–æ–‡ä»¶æ ¼å¼æµ‹è¯•æ­£å¸¸
   - é”™è¯¯å‘ç”Ÿåœ¨ VL æ¨¡å‹è°ƒç”¨ç¯èŠ‚

2. **é”™è¯¯ä¿¡æ¯æš´éœ²** âš ï¸
   - ç³»ç»Ÿå†…éƒ¨é”™è¯¯å †æ ˆå®Œæ•´æš´éœ²
   - åŒ…å«æ•æ„Ÿçš„ç³»ç»Ÿè·¯å¾„ä¿¡æ¯
   - æ˜¾ç¤ºäº†å†…éƒ¨æ¨¡å‹é…ç½®ç»†èŠ‚
   ```
   Error code: 400 - {'detail': '[address=0.0.0.0:28264, pid=8336] Model not found, uid: qwen2-vl-instruct-0'}
   ```

3. **ç³»ç»Ÿå“åº”é—®é¢˜** ğŸš«
   - é”™è¯¯å¤„ç†ä¸å¤Ÿä¼˜é›…
   - ç¼ºä¹åˆ†çº§çš„é”™è¯¯å¤„ç†æœºåˆ¶
   - ç”¨æˆ·ä½“éªŒä¸ä½³

### æ ¹æœ¬åŸå› åˆ†æ <img src="https://img.shields.io/badge/Root_Cause-FFA000?style=flat-square&logo=analytics&logoColor=white"/>

1. **ä»£ç ç»“æ„é—®é¢˜** ğŸ—ï¸
```python
try:
    # å¤§æ®µä»£ç å—æ²¡æœ‰ç»†åˆ†é”™è¯¯å¤„ç†
    content = await file.read()
    doc_result = await recognizeImageTextVL(...)
    text_content = process_result(...)
except Exception as e:
    # æ‰€æœ‰é”™è¯¯ç»Ÿä¸€å¤„ç†
    return error_response(str(e))
```

2. **é”™è¯¯å¤„ç†è®¾è®¡ç¼ºé™·** ğŸ› ï¸
   - æ²¡æœ‰åŒºåˆ†ä¸šåŠ¡é”™è¯¯å’Œç³»ç»Ÿé”™è¯¯
   - é”™è¯¯ä¿¡æ¯æ²¡æœ‰è„±æ•å¤„ç†
   - ç¼ºä¹é”™è¯¯æ¢å¤æœºåˆ¶

3. **ç³»ç»Ÿæ¶æ„è€ƒè™‘ä¸è¶³** ğŸ”§
   - æœåŠ¡å¥åº·æ£€æŸ¥æœºåˆ¶ç¼ºå¤±
   - é”™è¯¯ç›‘æ§å’ŒæŠ¥è­¦ä¸å®Œå–„
   - ç¼ºä¹é™çº§å’Œå®¹é”™ç­–ç•¥

## çŸ¥è¯†ç‚¹æ‹“å±• <img src="https://img.shields.io/badge/Knowledge-4CAF50?style=flat-square&logo=book&logoColor=white"/>

### FastAPI æ–‡ä»¶å¤„ç† ğŸ“‚

1. **æ–‡ä»¶ä¸Šä¼ æœºåˆ¶** ğŸ“¤
```python
from fastapi import UploadFile, File
   
async def upload_file(file: UploadFile = File(...)):
    content = await file.read()
    # é‡è¦ï¼šè¯»å–åéœ€è¦é‡ç½®æ–‡ä»¶æŒ‡é’ˆ
    file.file.seek(0)
    return content
```

2. **æ–‡ä»¶æŒ‡é’ˆç®¡ç†** ğŸ“
   - `BytesIO` çš„ä½¿ç”¨åœºæ™¯å’Œæ³¨æ„äº‹é¡¹
   - æ–‡ä»¶å¤åˆ¶å’ŒæŒ‡é’ˆé‡ç½®çš„æœ€ä½³å®è·µ
   - å†…å­˜ç®¡ç†å’Œèµ„æºé‡Šæ”¾

3. **æ–‡ä»¶éªŒè¯æµç¨‹** âœ…
```python
async def validate_file(file: UploadFile):
    # 1. æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥
    if not file:
        raise ValueError("æœªä¸Šä¼ æ–‡ä»¶")

    # 2. æ–‡ä»¶ç±»å‹æ£€æŸ¥
    if file.content_type not in SUPPORTED_IMAGE_TYPES:
        raise ValueError(f"ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: {file.content_type}")

    # 3. æ–‡ä»¶å¤§å°æ£€æŸ¥
    await check_file_size(file)

    # 4. æ–‡ä»¶å†…å®¹åŸºç¡€æ£€æŸ¥
    content = await file.read()
    if not content:
        raise ValueError("æ–‡ä»¶å†…å®¹ä¸ºç©º")

    return content
```

### é”™è¯¯å¤„ç†ä½“ç³» <img src="https://img.shields.io/badge/Error_Handling-FF5722?style=flat-square&logo=shield&logoColor=white"/>

1. **é”™è¯¯åˆ†ç±»ä½“ç³»** ğŸ”
```python
class BaseError(Exception):
    """åŸºç¡€é”™è¯¯ç±»"""
    def __init__(self, message: str, code: int = 400):
        self.message = message
        self.code = code
        super().__init__(self.message)

class BusinessError(BaseError):
    """ä¸šåŠ¡é”™è¯¯"""
    pass

class SystemError(BaseError):
    """ç³»ç»Ÿé”™è¯¯"""
    pass

class ValidationError(BusinessError):
    """éªŒè¯é”™è¯¯"""
    pass

class ModelError(SystemError):
    """æ¨¡å‹è°ƒç”¨é”™è¯¯"""
    pass
```

2. **é”™è¯¯å¤„ç†ç­–ç•¥** ğŸ›¡ï¸
```python
async def handle_error(error: Exception) -> dict:
    """ç»Ÿä¸€é”™è¯¯å¤„ç†"""
    if isinstance(error, BusinessError):
        # ä¸šåŠ¡é”™è¯¯ï¼šç›´æ¥è¿”å›ç»™ç”¨æˆ·
        return {
            "code": error.code,
            "message": error.message,
            "data": None
        }
    
    if isinstance(error, SystemError):
        # ç³»ç»Ÿé”™è¯¯ï¼šè®°å½•æ—¥å¿—ï¼Œè¿”å›å‹å¥½æç¤º
        logger.error(f"ç³»ç»Ÿé”™è¯¯: {error.message}")
        return {
            "code": 500,
            "message": "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨",
            "data": None
        }
    
    # æœªçŸ¥é”™è¯¯ï¼šè®°å½•è¯¦ç»†ä¿¡æ¯
    logger.error(f"æœªçŸ¥é”™è¯¯: {str(error)}\n{traceback.format_exc()}")
    return {
        "code": 500,
        "message": "ç³»ç»Ÿå¼‚å¸¸",
        "data": None
    }
```

3. **æ—¥å¿—è®°å½•è§„èŒƒ** ğŸ“
```python
def setup_logging():
    """æ—¥å¿—é…ç½®"""
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        handlers=[
            logging.StreamHandler(sys.stdout),
            logging.FileHandler('app.log')
        ]
    )

logger = logging.getLogger(__name__)

def log_error(e: Exception, context: dict = None):
    """é”™è¯¯æ—¥å¿—è®°å½•"""
    error_info = {
        "error_type": type(e).__name__,
        "error_message": str(e),
        "traceback": traceback.format_exc(),
        "context": context or {}
    }
    logger.error(f"é”™è¯¯è¯¦æƒ…: {json.dumps(error_info, ensure_ascii=False)}")
```

### è§†è§‰è¯­è¨€æ¨¡å‹é›†æˆ <img src="https://img.shields.io/badge/VL_Model-673AB7?style=flat-square&logo=openai&logoColor=white"/>

1. **æ¨¡å‹è°ƒç”¨å°è£…** ğŸ¤–
```python
async def vl_chat(
    image,
    prompt,
    image_type: str = "image",
    temperature: float = 0.4,
    top_p: float = 0.8,
    max_tokens: int = 1024
) -> str:
    """è§†è§‰è¯­è¨€æ¨¡å‹è°ƒç”¨"""
    try:
        # 1. åŸºç¡€éªŒè¯
        if image_type not in [i.value for i in ImageType]:
            raise ValueError(f"ä¸æ”¯æŒçš„å›¾åƒç±»å‹: {image_type}")

        # 2. æ„å»ºå®¢æˆ·ç«¯
        client = openai.Client(
            api_key="not empty",
            base_url="http://61.160.201.228:30961/v1",
            timeout=1000
        )

        # 3. æ¨¡å‹è°ƒç”¨
        completions = client.chat.completions.create(
            model="qwen2-vl-instruct",
            messages=[{
                "content": [
                    {"type": image_type, image_type: image},
                    {"type": "text", "text": prompt}
                ],
                "role": "user"
            }],
            temperature=temperature,
            top_p=top_p,
            max_tokens=max_tokens,
            timeout=2000,
            extra_body={"repetition_penalty": 1.2}
        )

        # 4. ç»“æœå¤„ç†
        return completions.choices[0].message.content

    except Exception as e:
        logger.error(f"VLæ¨¡å‹è°ƒç”¨å¤±è´¥: {str(e)}")
        raise ModelError(f"æ¨¡å‹æœåŠ¡å¼‚å¸¸: {str(e)}")
```

2. **å›¾åƒå¤„ç†æµç¨‹** ğŸ–¼ï¸
```python
async def process_image_content(content: bytes) -> str:
    """å›¾åƒå†…å®¹å¤„ç†"""
    try:
        # 1. åˆ›å»ºå›¾åƒå¯¹è±¡
        image = Image.open(BytesIO(content))

        # 2. å›¾åƒå¢å¼º
        enhanced_image = enhance_image(image)

        # 3. æ–‡æœ¬è¯†åˆ«
        text = await extract_page_text(enhanced_image)

        # 4. å†…å®¹æ¸…ç†
        cleaned_text = clean_text(text)

        return cleaned_text

    except Exception as e:
        logger.error(f"å›¾åƒå¤„ç†å¤±è´¥: {str(e)}")
        raise ProcessingError("å›¾åƒå¤„ç†å¤±è´¥")
```

## æŠ€æœ¯æ·±åº¦è§£æ <img src="https://img.shields.io/badge/Deep_Dive-2196F3?style=flat-square&logo=target&logoColor=white"/>

### FastAPI ä¸­çš„æ–‡ä»¶å¤„ç†æœºåˆ¶ ğŸ“

1. **æ–‡ä»¶ä¸Šä¼ åŸç†** ğŸ“¤
   - FastAPI ä½¿ç”¨ `python-multipart` å¤„ç†æ–‡ä»¶ä¸Šä¼ 
   - æ–‡ä»¶ä»¥æµçš„å½¢å¼å¤„ç†ï¼Œå‡å°‘å†…å­˜å ç”¨
   - æ”¯æŒå¼‚æ­¥æ“ä½œï¼Œæé«˜æ€§èƒ½

2. **å†…å­˜ç®¡ç†è€ƒè™‘**
   - ä½¿ç”¨ `BytesIO` åˆ›å»ºå†…å­˜ä¸­çš„æ–‡ä»¶å¯¹è±¡
   - åŠæ—¶å…³é—­æ–‡ä»¶å¥æŸ„ï¼Œé¿å…å†…å­˜æ³„æ¼
   - å¤§æ–‡ä»¶å¤„ç†æ—¶ä½¿ç”¨æµå¼å¤„ç†

3. **æ–‡ä»¶éªŒè¯æœ€ä½³å®è·µ**
   - æ–‡ä»¶ç±»å‹ç™½åå•éªŒè¯
   - æ–‡ä»¶å¤§å°é™åˆ¶
   - æ–‡ä»¶å†…å®¹å®‰å…¨æ£€æŸ¥

#### 2. é”™è¯¯å¤„ç†ä¸å¼‚å¸¸ç®¡ç†
1. **é”™è¯¯åˆ†çº§ç­–ç•¥**
   - L1ï¼šç”¨æˆ·è¾“å…¥é”™è¯¯ï¼ˆå‰ç«¯å¯å¤„ç†ï¼‰
   - L2ï¼šä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼ˆéœ€è¦ç”¨æˆ·å…³æ³¨ï¼‰
   - L3ï¼šç³»ç»Ÿå†…éƒ¨é”™è¯¯ï¼ˆéœ€è¦å¼€å‘äººå‘˜å…³æ³¨ï¼‰
   - L4ï¼šè‡´å‘½é”™è¯¯ï¼ˆéœ€è¦ç«‹å³å¹²é¢„ï¼‰

2. **é”™è¯¯æ¢å¤æœºåˆ¶**
   ```python
   async def with_retry(func, max_retries=3):
       """å¸¦é‡è¯•çš„å‡½æ•°æ‰§è¡Œ"""
       for i in range(max_retries):
           try:
               return await func()
           except Exception as e:
               if i == max_retries - 1:
                   raise
               logger.warning(f"é‡è¯• {i+1}/{max_retries}: {str(e)}")
               await asyncio.sleep(1 * (i + 1))
   ```

3. **é”™è¯¯ç›‘æ§ä¸æŠ¥è­¦**
   - é”™è¯¯é¢‘ç‡ç›‘æ§
   - é”™è¯¯ç±»å‹åˆ†å¸ƒåˆ†æ
   - å…³é”®é”™è¯¯å®æ—¶æŠ¥è­¦

#### 3. ç³»ç»Ÿå¥å£®æ€§è®¾è®¡
1. **æœåŠ¡å¥åº·æ£€æŸ¥**
   ```python
   @app.get("/health")
   async def health_check():
       """æœåŠ¡å¥åº·æ£€æŸ¥"""
       status = {
           "service": check_service_status(),
           "model": check_model_status(),
           "database": check_database_status()
       }
       return {"status": "healthy" if all(status.values()) else "unhealthy"}
   ```

2. **æ€§èƒ½ç›‘æ§**
   ```python
   class PerformanceMonitor:
       """æ€§èƒ½ç›‘æ§å™¨"""
       def __init__(self):
           self.metrics = defaultdict(list)
   
       def record(self, name: str, duration: float):
           self.metrics[name].append(duration)
   
       def get_statistics(self):
           return {
               name: {
                   "avg": statistics.mean(values),
                   "max": max(values),
                   "min": min(values),
                   "count": len(values)
               }
               for name, values in self.metrics.items()
           }
   ```

3. **é™çº§ç­–ç•¥**
   ```python
   class ServiceDegrader:
       """æœåŠ¡é™çº§æ§åˆ¶"""
       def __init__(self):
           self.error_count = 0
           self.error_threshold = 10
           self.reset_interval = 300  # 5åˆ†é’Ÿ
   
       def should_degrade(self) -> bool:
           """åˆ¤æ–­æ˜¯å¦éœ€è¦é™çº§"""
           return self.error_count >= self.error_threshold
   
       def record_error(self):
           """è®°å½•é”™è¯¯"""
           self.error_count += 1
   
       def reset(self):
           """é‡ç½®è®¡æ•°"""
           self.error_count = 0
   ```

### çŸ¥è¯†å›¾è°±æ„å»º

#### 1. æ ¸å¿ƒæŠ€æœ¯é¢†åŸŸ
1. **Web åç«¯å¼€å‘**
   - FastAPI æ¡†æ¶
   - å¼‚æ­¥ç¼–ç¨‹
   - REST API è®¾è®¡

2. **æ–‡ä»¶å¤„ç†**
   - æ–‡ä»¶ä¸Šä¼ 
   - å†…å­˜ç®¡ç†
   - æµå¼å¤„ç†

3. **äººå·¥æ™ºèƒ½é›†æˆ**
   - æ¨¡å‹è°ƒç”¨
   - è§†è§‰è¯†åˆ«
   - ç»“æœå¤„ç†

4. **ç³»ç»Ÿæ¶æ„**
   - é”™è¯¯å¤„ç†
   - æ€§èƒ½ä¼˜åŒ–
   - ç›‘æ§å‘Šè­¦

#### 2. æŠ€æœ¯å…³è”åˆ†æ
1. **æ¨ªå‘å…³è”**
   - æ–‡ä»¶å¤„ç† â†’ æ¨¡å‹è°ƒç”¨ â†’ ç»“æœåˆ†æ
   - é”™è¯¯å¤„ç† â†” æ—¥å¿—è®°å½• â†” ç›‘æ§å‘Šè­¦
   - æ€§èƒ½ä¼˜åŒ– â†” èµ„æºç®¡ç† â†” ç³»ç»Ÿç¨³å®šæ€§

2. **çºµå‘å…³è”**
   - åº”ç”¨å±‚ï¼šAPI æ¥å£ã€ä¸šåŠ¡é€»è¾‘
   - æœåŠ¡å±‚ï¼šæ¨¡å‹æœåŠ¡ã€æ–‡ä»¶æœåŠ¡
   - åŸºç¡€å±‚ï¼šé”™è¯¯å¤„ç†ã€æ—¥å¿—è®°å½•ã€ç›‘æ§å‘Šè­¦

#### 3. ä¼˜åŒ–å»ºè®®
1. **çŸ­æœŸä¼˜åŒ–**
   - å®Œå–„é”™è¯¯å¤„ç†æœºåˆ¶
   - å¢å¼ºæ—¥å¿—è®°å½•ç³»ç»Ÿ
   - æ·»åŠ åŸºç¡€ç›‘æ§æŒ‡æ ‡

2. **ä¸­æœŸè§„åˆ’**
   - å®ç°æœåŠ¡é™çº§æœºåˆ¶
   - å¼•å…¥æ€§èƒ½ç›‘æ§ç³»ç»Ÿ
   - ä¼˜åŒ–èµ„æºä½¿ç”¨æ•ˆç‡

3. **é•¿æœŸç›®æ ‡**
   - å»ºç«‹å®Œæ•´çš„ç›‘æ§å‘Šè­¦ä½“ç³»
   - å®ç°æ™ºèƒ½è¿ç»´èƒ½åŠ›
   - æå‡ç³»ç»Ÿæ•´ä½“å¯ç”¨æ€§

> æœ¬æ¬¡å­¦ä¹ çš„æ ¸å¿ƒä»·å€¼åœ¨äºæ·±å…¥ç†è§£äº†ç³»ç»Ÿé”™è¯¯å¤„ç†å’Œå¥å£®æ€§è®¾è®¡çš„é‡è¦æ€§ã€‚é€šè¿‡åˆ†æå…·ä½“é—®é¢˜ï¼Œæˆ‘ä»¬ä¸ä»…è§£å†³äº†å½“å‰çš„é”™è¯¯å¤„ç†é—®é¢˜ï¼Œè¿˜å»ºç«‹äº†ä¸€ä¸ªæ›´å®Œæ•´çš„æŠ€æœ¯ä½“ç³»ï¼Œä¸ºä»Šåçš„ç³»ç»Ÿä¼˜åŒ–å’Œç»´æŠ¤æä¾›äº†é‡è¦å‚è€ƒã€‚

